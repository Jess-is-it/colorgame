{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Live Feed</h2>

  <div class="row">
    <span class="muted">RTMP publish status:</span>
    <span id="rtmpPublish" class="mono">checking...</span>
    <a class="muted" href="{{ stat_url }}" target="_blank" rel="noopener">rtmp stat</a>
  </div>

  <div class="row">
    <span class="muted">HLS URL:</span>
    <span class="mono">{{ hls_url }}</span>
  </div>

  <div class="preview" style="margin-top: 12px;">
    <video id="video" controls autoplay muted playsinline></video>
    <div id="videoMsg" class="muted">Loading stream…</div>
  </div>
</section>

<script src="/static/hls.min.js?v={{ static_version }}"></script>
<script>
  const hlsUrl = {{ hls_url | tojson }};

  async function pollRtmp() {
    try {
      const r = await fetch('/api/rtmp/status');
      const j = await r.json();
      const pub = !!j.publishing;
      document.getElementById('rtmpPublish').textContent = pub ? 'publishing' : 'not publishing';
    } catch (_) {
      document.getElementById('rtmpPublish').textContent = 'unknown';
    }
    setTimeout(pollRtmp, 1000);
  }
  pollRtmp();

  const video = document.getElementById('video');
  const msg = document.getElementById('videoMsg');

  // Use hls.js for Chrome/Firefox/Edge. Safari can play HLS natively.
  (function start() {
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      msg.textContent = 'Using native HLS…';
      video.src = hlsUrl;
      msg.textContent = '';
      return;
    }

    if (!window.Hls || !window.Hls.isSupported()) {
      msg.textContent = 'HLS not supported in this browser.';
      return;
    }

    msg.textContent = 'Attaching HLS…';
    const hls = new window.Hls({
      liveSyncDurationCount: 3,
      maxLiveSyncPlaybackRate: 1.25,
    });

    hls.on(window.Hls.Events.ERROR, function (_evt, data) {
      const details = data && data.details ? String(data.details) : 'unknown';
      msg.textContent = `HLS error: ${details} (waiting/retrying…)`;
    });

    hls.loadSource(hlsUrl);
    hls.attachMedia(video);
    msg.textContent = '';
  })();
</script>
{% endblock %}
