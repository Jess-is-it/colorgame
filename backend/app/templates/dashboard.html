{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Dashboard</h2>

  <div class="row">
    <span class="muted">Stream status:</span>
    <span id="streamStatus" class="mono">checking…</span>
    <span id="streamTracks" class="muted"></span>
  </div>

  <details style="margin-top: 10px;">
    <summary>OBS Settings (RTMP)</summary>
    <div style="margin-top: 8px;">
      <div class="row">
        <span class="muted">Service:</span>
        <span class="mono">Custom…</span>
      </div>
      <div class="row">
        <span class="muted">Server:</span>
        <span class="mono">{{ rtmp_server }}</span>
      </div>
      <div class="row">
        <span class="muted">Stream key:</span>
        <span class="mono">{{ rtmp_stream_key }}</span>
      </div>
      <div class="row">
        <span class="muted">Tip:</span>
        <span class="muted">For browser compatibility, use H.264 video + AAC audio in OBS.</span>
      </div>
    </div>
  </details>

  <div class="preview" style="margin-top: 12px;">
    <iframe
      id="playerFrame"
      title="Live feed"
      src="{{ webrtc_player_url }}"
      allow="autoplay; fullscreen; picture-in-picture"
      allowfullscreen
      referrerpolicy="no-referrer"
    ></iframe>
  </div>

  <div class="row" style="margin-top: 10px;">
    <a class="muted" href="{{ webrtc_player_url }}" target="_blank" rel="noopener">Open player in new tab</a>
  </div>
</section>

<script>
  async function pollStatus() {
    try {
      const r = await fetch('/api/stream/status');
      const j = await r.json();
      const pub = !!j.publishing;
      document.getElementById('streamStatus').textContent = pub ? 'connected (publishing)' : 'disconnected';
      const tracks = Array.isArray(j.tracks) ? j.tracks.join(' · ') : '';
      document.getElementById('streamTracks').textContent = tracks ? `(${tracks})` : '';
    } catch (_) {
      document.getElementById('streamStatus').textContent = 'unknown';
      document.getElementById('streamTracks').textContent = '';
    }
    setTimeout(pollStatus, 1000);
  }
  pollStatus();
</script>
{% endblock %}
