{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Dashboard</h2>

  <div class="row">
    <span class="muted">Stream status:</span>
    <span id="streamStatus" class="mono">checking…</span>
    <span id="streamTracks" class="muted"></span>
    <span id="streamSource" class="muted"></span>
  </div>

  <details style="margin-top: 10px;">
    <summary>Connection Debug</summary>
    <div style="margin-top: 8px;">
      <div class="row">
        <span class="muted">WebRTC sessions:</span>
        <span id="webrtcSessions" class="mono">checking…</span>
      </div>
      <div class="row">
        <span class="muted">Latest ICE:</span>
        <span id="webrtcIce" class="mono"></span>
      </div>
    </div>
  </details>

  <details style="margin-top: 10px;" open>
    <summary>OBS Settings (Recommended: WHIP / WebRTC)</summary>
    <div style="margin-top: 8px;">
      <div class="row">
        <span class="muted">Service:</span>
        <span class="mono">WHIP</span>
      </div>
      <div class="row">
        <span class="muted">Server:</span>
        <span class="mono">{{ whip_url }}</span>
      </div>
      <div class="row">
        <span class="muted">Stream key:</span>
        <span class="mono">(empty)</span>
      </div>
      <div class="row">
        <span class="muted">Tip:</span>
        <span class="muted">WHIP avoids the RTMP→WebRTC audio mismatch and is the lowest-latency path.</span>
      </div>
    </div>
  </details>

  <details style="margin-top: 10px;">
    <summary>OBS Settings (Alternate: RTMP)</summary>
    <div style="margin-top: 8px;">
      <div class="row">
        <span class="muted">Service:</span>
        <span class="mono">Custom…</span>
      </div>
      <div class="row">
        <span class="muted">Server:</span>
        <span class="mono">{{ rtmp_server }}</span>
      </div>
      <div class="row">
        <span class="muted">Stream key:</span>
        <span class="mono">{{ rtmp_stream_key }}</span>
      </div>
      <div class="row">
        <span class="muted">Note:</span>
        <span class="muted">If the player says “peer connection closed”, it’s often because your H.264 has B-frames enabled. Set B-frames = 0 and Profile = Baseline/Constrained Baseline.</span>
      </div>
    </div>
  </details>

  <div class="preview" style="margin-top: 12px;">
    <iframe
      id="playerFrame"
      title="Live feed"
      src="{{ webrtc_player_url }}"
      allow="autoplay; fullscreen; picture-in-picture"
      allowfullscreen
      referrerpolicy="no-referrer"
    ></iframe>
  </div>

  <div class="row" style="margin-top: 10px;">
    <a class="muted" href="{{ webrtc_player_url }}" target="_blank" rel="noopener">Open player in new tab</a>
  </div>
</section>

<script>
  async function pollStatus() {
    try {
      const r = await fetch('/api/stream/status');
      const j = await r.json();
      const pub = !!j.publishing;
      document.getElementById('streamStatus').textContent = pub ? 'connected (publishing)' : 'disconnected';
      const tracks = Array.isArray(j.tracks) ? j.tracks.join(' · ') : '';
      document.getElementById('streamTracks').textContent = tracks ? `(${tracks})` : '';
      const sourceType = j && j.source && j.source.type ? String(j.source.type) : '';
      document.getElementById('streamSource').textContent = sourceType ? `source: ${sourceType}` : '';
    } catch (_) {
      document.getElementById('streamStatus').textContent = 'unknown';
      document.getElementById('streamTracks').textContent = '';
      document.getElementById('streamSource').textContent = '';
    }
    setTimeout(pollStatus, 1000);
  }
  pollStatus();

  async function pollWebrtc() {
    try {
      const r = await fetch('/api/webrtc/sessions');
      const j = await r.json();
      const items = Array.isArray(j.items) ? j.items : [];
      document.getElementById('webrtcSessions').textContent = String(items.length);

      if (items.length > 0) {
        const last = items[items.length - 1];
        const lc = last.localCandidate ? String(last.localCandidate) : '';
        const rc = last.remoteCandidate ? String(last.remoteCandidate) : '';
        document.getElementById('webrtcIce').textContent = `${lc}  <=  ${rc}`;
      } else {
        document.getElementById('webrtcIce').textContent = '';
      }
    } catch (_) {
      document.getElementById('webrtcSessions').textContent = 'unknown';
      document.getElementById('webrtcIce').textContent = '';
    }
    setTimeout(pollWebrtc, 1500);
  }
  pollWebrtc();
</script>
{% endblock %}
