# Minimal nginx-rtmp config for OBS ingest.
# OBS publishes to: rtmp://<VM_IP>:1935/live  (stream key becomes stream name)
# This also exposes HLS over HTTP so the dashboard can show a live feed.

error_log /dev/stdout info;

events {
  worker_connections 1024;
}

rtmp {
  server {
    listen 1935;
    chunk_size 4096;

    application live {
      live on;
      record off;
      # Generate HLS using ffmpeg for better browser compatibility and more stable playlists.
      # Low-latency tuning:
      # - 1s segments, 3-segment playlist (~3s baseline)
      # - forced keyframes each 1s so every segment is independently decodable
      exec ffmpeg -hide_banner -loglevel error -i rtmp://localhost:1935/live/$name -c:v libx264 -preset veryfast -tune zerolatency -g 30 -keyint_min 30 -sc_threshold 0 -force_key_frames expr:gte(t,n_forced*1) -c:a aac -ar 44100 -b:a 128k -muxdelay 0 -muxpreload 0 -f hls -hls_time 1 -hls_list_size 3 -hls_flags delete_segments+append_list+omit_endlist+independent_segments -hls_segment_filename /opt/data/hls/$name-%05d.ts /opt/data/hls/$name.m3u8;
    }
  }
}

http {
  server {
    listen 80;

    location /health { return 200 "ok\n"; }

    # RTMP stats (XML)
    location /stat { rtmp_stat all; }

    # HLS playlist + segments
    location /hls/ {
      types {
        application/vnd.apple.mpegurl m3u8;
        video/mp2t ts;
      }
      # Use alias to avoid path quirks while playlist/segments are being rewritten.
      alias /opt/data/hls/;
      add_header Cache-Control no-cache;
      add_header Access-Control-Allow-Origin * always;
      add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Range" always;
      add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;
      if ($request_method = OPTIONS) { return 204; }
    }
  }
}
