{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="row between">
    <div>
      <h2>Live</h2>
      <div class="muted">OBS stream + latest detected result.</div>
    </div>
    <div class="row">
      <span class="muted">Stream:</span>
      <span id="streamStatus" class="mono">checking…</span>
      <span id="streamTracks" class="muted"></span>
    </div>
  </div>

  <div class="split" style="margin-top: 12px;">
    <div class="card" style="padding: 12px;">
      <div class="preview">
        <iframe
          id="playerFrame"
          title="Live feed"
          src="{{ webrtc_player_url }}"
          allow="autoplay; fullscreen; picture-in-picture"
          allowfullscreen
          referrerpolicy="no-referrer"
        ></iframe>
      </div>
      <div class="row" style="margin-top: 10px;">
        <a class="muted" href="{{ webrtc_player_url }}" target="_blank" rel="noopener">Open player in new tab</a>
      </div>

      <details style="margin-top: 10px;">
        <summary>OBS Settings (Recommended: WHIP)</summary>
        <div style="margin-top: 8px;">
          <div class="row">
            <span class="muted">Service:</span>
            <span class="mono">WHIP</span>
          </div>
          <div class="row">
            <span class="muted">Server:</span>
            <span class="mono">{{ whip_url }}</span>
          </div>
          <div class="row">
            <span class="muted">Stream key:</span>
            <span class="mono">(empty)</span>
          </div>
        </div>
      </details>
    </div>

    <aside class="card" style="padding: 12px;">
      <h2 style="margin-bottom: 8px;">Latest Win</h2>

      <div class="row">
        <span class="muted">Active draw:</span>
        <span id="activeDraw" class="mono">…</span>
      </div>

      <div class="row">
        <span class="muted">Colors:</span>
        <span id="latestColors" class="mono"></span>
      </div>

      <div class="row">
        <span class="muted">Time:</span>
        <span id="latestTime" class="mono"></span>
      </div>

      <div class="row">
        <span class="muted">Detector:</span>
        <span id="detStatus" class="mono">…</span>
      </div>

      <div class="row">
        <button class="btn primary" id="detStart">Start</button>
        <button class="btn" id="detStop">Stop</button>
      </div>

      <div class="hr"></div>

      <details>
        <summary>Connection Debug</summary>
        <div style="margin-top: 8px;">
          <div class="row">
            <span class="muted">WebRTC sessions:</span>
            <span id="webrtcSessions" class="mono">…</span>
          </div>
          <div class="row">
            <span class="muted">Latest ICE:</span>
            <span id="webrtcIce" class="mono"></span>
          </div>
        </div>
      </details>

      <div class="row" style="margin-top: 10px;">
        <a class="muted" href="/draw">Go to Draw page</a>
      </div>
    </aside>
  </div>
</section>

<script>
  async function pollStream() {
    try {
      const r = await fetch('/api/stream/status');
      const j = await r.json();
      const pub = !!j.publishing;
      document.getElementById('streamStatus').textContent = pub ? 'connected' : 'disconnected';
      const tracks = Array.isArray(j.tracks) ? j.tracks.join(' · ') : '';
      document.getElementById('streamTracks').textContent = tracks ? `(${tracks})` : '';
    } catch (_) {
      document.getElementById('streamStatus').textContent = 'unknown';
      document.getElementById('streamTracks').textContent = '';
    }
    setTimeout(pollStream, 1000);
  }
  pollStream();

  async function pollWebrtc() {
    try {
      const r = await fetch('/api/webrtc/sessions');
      const j = await r.json();
      const items = Array.isArray(j.items) ? j.items : [];
      document.getElementById('webrtcSessions').textContent = String(items.length);
      if (items.length > 0) {
        const last = items[items.length - 1];
        const lc = last.localCandidate ? String(last.localCandidate) : '';
        const rc = last.remoteCandidate ? String(last.remoteCandidate) : '';
        document.getElementById('webrtcIce').textContent = `${lc}  <=  ${rc}`;
      } else {
        document.getElementById('webrtcIce').textContent = '';
      }
    } catch (_) {
      document.getElementById('webrtcSessions').textContent = 'unknown';
      document.getElementById('webrtcIce').textContent = '';
    }
    setTimeout(pollWebrtc, 1500);
  }
  pollWebrtc();

  async function pollDetector() {
    try {
      const r = await fetch('/api/detector/status');
      const j = await r.json();
      const status = j.running ? (j.connected ? 'running' : 'running (disconnected)') : 'stopped';
      document.getElementById('detStatus').textContent = status;

      const ad = j.active_draw ? `${j.active_draw.name}` : '(none)';
      document.getElementById('activeDraw').textContent = ad;

      const lr = j.last_result;
      document.getElementById('latestColors').textContent = lr ? lr.colors.join(', ') : '';
      document.getElementById('latestTime').textContent = lr ? lr.timestamp : '';
    } catch (_) {
      document.getElementById('detStatus').textContent = 'unknown';
      document.getElementById('activeDraw').textContent = 'unknown';
      document.getElementById('latestColors').textContent = '';
      document.getElementById('latestTime').textContent = '';
    }
    setTimeout(pollDetector, 1000);
  }
  pollDetector();

  document.getElementById('detStart').addEventListener('click', async () => {
    await fetch('/api/detector/start', { method: 'POST' });
  });
  document.getElementById('detStop').addEventListener('click', async () => {
    await fetch('/api/detector/stop', { method: 'POST' });
  });
</script>
{% endblock %}

