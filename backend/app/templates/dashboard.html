{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Live Feed</h2>

  <div class="row">
    <span class="muted">RTMP publish status:</span>
    <span id="rtmpPublish" class="mono">checking...</span>
    <a class="muted" href="{{ stat_url }}" target="_blank" rel="noopener">rtmp stat</a>
  </div>

  <div class="row">
    <span class="muted">HLS URL:</span>
    <span class="mono">{{ hls_url }}</span>
  </div>

  <div class="preview" style="margin-top: 12px;">
    <video id="video" controls autoplay muted playsinline></video>
    <div id="videoMsg" class="muted">Loading stream…</div>
  </div>
</section>

<script>
  const hlsUrl = {{ hls_url | tojson }};

  async function pollRtmp() {
    try {
      const r = await fetch('/api/rtmp/status');
      const j = await r.json();
      const pub = !!j.publishing;
      document.getElementById('rtmpPublish').textContent = pub ? 'publishing' : 'not publishing';
    } catch (_) {
      document.getElementById('rtmpPublish').textContent = 'unknown';
    }
    setTimeout(pollRtmp, 1000);
  }
  pollRtmp();

  const video = document.getElementById('video');
  const msg = document.getElementById('videoMsg');

  // Use hls.js for Chrome/Firefox/Edge. Safari can play HLS natively.
  (function start() {
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = hlsUrl;
      msg.textContent = '';
      return;
    }

    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/hls.js@1';
    s.onload = () => {
      if (!window.Hls || !window.Hls.isSupported()) {
        msg.textContent = 'HLS not supported in this browser.';
        return;
      }
      const hls = new window.Hls({ liveSyncDurationCount: 2, maxLiveSyncPlaybackRate: 1.25 });
      hls.loadSource(hlsUrl);
      hls.attachMedia(video);
      hls.on(window.Hls.Events.ERROR, function (evt, data) {
        // Most common: playlist not available yet.
        msg.textContent = 'Waiting for HLS… (is OBS streaming?)';
      });
      msg.textContent = '';
    };
    s.onerror = () => { msg.textContent = 'Failed to load hls.js (check internet connectivity).'; };
    document.head.appendChild(s);
  })();
</script>
{% endblock %}
